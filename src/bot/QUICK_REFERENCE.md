# üê∑ Oink Bot Quick Reference

Quick reference guide for common development tasks and patterns.

## üöÄ Adding a New Command (4 Steps)

### 1. Create Handler
```typescript
// src/handlers/MyCommandHandler.ts
import { CommandInteraction } from 'discord.js';
import { CommandHandler } from './CommandHandler';

export class MyCommandHandler extends CommandHandler {
    public async handleCommand(interaction: CommandInteraction): Promise<void> {
        try {
            // Your logic here
            await interaction.reply('üê∑ Oink!');
        } catch (error) {
            await this.handleError(interaction, error);
        }
    }
}
```

### 2. Register Command
```typescript
// src/bot/CommandRegistry.ts - in initializeCommands()
this.registerCommand(CommandFactory.createUtilityCommand(
    'mycommand',
    'üê∑ Description',
    [
        {
            name: 'input',
            description: 'Input description',
            required: true,
            type: 'string'
        }
    ]
));
```

### 3. Add to Service Container
```typescript
// src/bot/ServiceContainer.ts
private myCommandHandler: MyCommandHandler;

constructor() {
    this.myCommandHandler = new MyCommandHandler();
}

public get myHandler(): MyCommandHandler {
    return this.myCommandHandler;
}
```

### 4. Route Interactions
```typescript
// src/bot/InteractionRouter.ts - in handleCommand()
case 'mycommand':
    await this.serviceContainer.myHandler.handleCommand(interaction);
    break;
```

## üìù Command Types & Factory Methods

### Utility Command
```typescript
CommandFactory.createUtilityCommand(
    'name',
    'description',
    options?,           // CommandOption[]
    metadata?           // Partial<CommandDefinition>
)
```

### Payment Command
```typescript
CommandFactory.createPaymentCommand(
    'name',
    'description',
    options?,           // CommandOption[]
    metadata?           // Partial<CommandDefinition>
)
```

### Admin Command
```typescript
CommandFactory.createAdminCommand(
    'name',
    'description',
    options?,           // CommandOption[]
    metadata?           // Partial<CommandDefinition>
)
```

### Custom Command
```typescript
CommandFactory.createCommand({
    name: 'name',
    description: 'description',
    category: CommandCategory.UTILITY,
    options: [...],
    subcommands: [...],
    permissions: ['ManageGuild'],
    cooldown: 30,
    guildOnly: true
})
```

## üîß Command Options

### Option Types
```typescript
interface CommandOption {
    name: string;
    description: string;
    required: boolean;
    type: 'string' | 'number' | 'integer' | 'boolean' | 'user' | 'channel' | 'role';
    minValue?: number;
    maxValue?: number;
    choices?: { name: string; value: string | number }[];
}
```

### Common Option Patterns
```typescript
// String with choices
{
    name: 'currency',
    description: 'Currency to use',
    required: true,
    type: 'string',
    choices: [
        { name: 'USD', value: 'USD' },
        { name: 'EUR', value: 'EUR' }
    ]
}

// Number with validation
{
    name: 'amount',
    description: 'Amount to transfer',
    required: true,
    type: 'number',
    minValue: 0.01,
    maxValue: 10000
}

// User mention
{
    name: 'recipient',
    description: 'User to send to',
    required: true,
    type: 'user'
}
```

## üé® Command Metadata

### Available Metadata
```typescript
interface CommandDefinition {
    name: string;
    description: string;
    builder: SlashCommandBuilder;
    category: CommandCategory;
    permissions?: string[];
    cooldown?: number;
    guildOnly?: boolean;
    aliases?: string[];
    examples?: string[];
    usage?: string;
    longDescription?: string;
    requiresSetup?: boolean;
    isEphemeral?: boolean;
    maxUses?: number;
    minLevel?: number;
}
```

### Category Enum
```typescript
enum CommandCategory {
    PAYMENT = 'payment',
    REQUESTS = 'requests',
    TRANSACTIONS = 'transactions',
    SETUP = 'setup',
    CONFIG = 'config',
    UTILITY = 'utility',
    ADMIN = 'admin',
    HELP = 'help'
}
```

## üîÑ Interaction Handling

### Command Interaction
```typescript
public async handleCommand(interaction: CommandInteraction): Promise<void> {
    // Get options
    const user = interaction.options.getUser('recipient');
    const amount = interaction.options.getNumber('amount');
    const description = interaction.options.getString('description');
    
    // Handle command
    await interaction.reply('Processing...');
}
```

### Button Interaction
```typescript
// In InteractionRouter.ts
case 'confirm_payment':
    await this.serviceContainer.paymentHandler.handleConfirmButton(interaction);
    break;
```

### Select Menu Interaction
```typescript
// In InteractionRouter.ts
case 'payment_method':
    await this.serviceContainer.paymentHandler.handleMethodSelection(interaction);
    break;
```

### Modal Submission
```typescript
// In InteractionRouter.ts
case 'payment_form':
    await this.serviceContainer.paymentHandler.handlePaymentForm(interaction);
    break;
```

## üß™ Testing Patterns

### Unit Test Template
```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { MyCommandHandler } from '../MyCommandHandler';
import { createMockInteraction } from '@test/utils/MockDiscordServer';

describe('MyCommandHandler', () => {
    let handler: MyCommandHandler;
    let mockInteraction: any;

    beforeEach(() => {
        handler = new MyCommandHandler();
        mockInteraction = createMockInteraction('mycommand');
    });

    it('should handle command successfully', async () => {
        await handler.handleCommand(mockInteraction);
        expect(mockInteraction.reply).toHaveBeenCalledWith('üê∑ Oink!');
    });
});
```

### Integration Test Template
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { DiscordBot } from '@bot/DiscordBot';

describe('MyCommand Integration', () => {
    let bot: DiscordBot;

    beforeAll(async () => {
        bot = new DiscordBot();
        await bot.start();
    });

    afterAll(async () => {
        await bot.stop();
    });

    it('should register command with Discord', async () => {
        const commands = await bot.getCommandStats();
        expect(commands.total).toBeGreaterThan(0);
    });
});
```

## üîí Security & Validation

### Permission Checking
```typescript
// Check bot permissions
if (!interaction.guild?.members.me?.permissions.has('SendMessages')) {
    await interaction.reply({ content: '‚ùå Bot needs Send Messages permission', ephemeral: true });
    return;
}

// Check user permissions
if (!interaction.memberPermissions?.has('ManageGuild')) {
    await interaction.reply({ content: '‚ùå You need Manage Server permission', ephemeral: true });
    return;
}
```

### Input Validation
```typescript
// Validate amount
const amount = interaction.options.getNumber('amount');
if (!amount || amount <= 0) {
    await interaction.reply({ content: '‚ùå Amount must be greater than 0', ephemeral: true });
    return;
}

// Validate user
const user = interaction.options.getUser('recipient');
if (user.id === interaction.user.id) {
    await interaction.reply({ content: '‚ùå Cannot send to yourself', ephemeral: true });
    return;
}
```

## üìä Response Patterns

### Immediate Response
```typescript
await interaction.reply('üê∑ Processing your request...');
```

### Deferred Response
```typescript
await interaction.deferReply();
// ... do work ...
await interaction.editReply('üê∑ Request completed!');
```

### Ephemeral Response
```typescript
await interaction.reply({
    content: 'üê∑ This is private!',
    ephemeral: true
});
```

### Error Response
```typescript
try {
    // ... command logic ...
} catch (error) {
    await this.handleError(interaction, error);
}
```

## üóÇÔ∏è File Organization

### Handler Location
```
src/handlers/
‚îú‚îÄ‚îÄ payment/           # Payment commands
‚îÇ   ‚îú‚îÄ‚îÄ PaymentCommandHandler.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ requests/          # Request commands
‚îÇ   ‚îú‚îÄ‚îÄ RequestCommandHandler.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ transactions/      # Transaction commands
‚îÇ   ‚îú‚îÄ‚îÄ TransactionCommandHandler.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ setup/            # Setup commands
‚îÇ   ‚îú‚îÄ‚îÄ SetupCommandHandler.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îî‚îÄ‚îÄ index.ts          # Export all handlers
```

### Service Location
```
src/services/
‚îú‚îÄ‚îÄ PaymentService.ts
‚îú‚îÄ‚îÄ UserAccountService.ts
‚îú‚îÄ‚îÄ ServerConfigService.ts
‚îú‚îÄ‚îÄ EscrowManager.ts
‚îú‚îÄ‚îÄ NotificationService.ts
‚îî‚îÄ‚îÄ index.ts
```

### Model Location
```
src/models/
‚îú‚îÄ‚îÄ UserAccount.ts
‚îú‚îÄ‚îÄ Transaction.ts
‚îú‚îÄ‚îÄ PaymentRequest.ts
‚îú‚îÄ‚îÄ ServerConfig.ts
‚îú‚îÄ‚îÄ EscrowRecord.ts
‚îî‚îÄ‚îÄ index.ts
```

## üîç Common Debugging

### Check Registered Commands
```typescript
// Add debug command
this.registerCommand(CommandFactory.createUtilityCommand(
    'debug-commands',
    'üê∑ Show all commands (Debug)',
    [],
    { isEphemeral: true }
));

// In handler
const commands = this.serviceContainer.commandRegistry.getAllCommands();
const commandList = commands.map(cmd => `/${cmd.name}: ${cmd.description}`).join('\n');
await interaction.reply({ content: `**Registered Commands:**\n${commandList}`, ephemeral: true });
```

### Check Bot Permissions
```typescript
// Add debug command
this.registerCommand(CommandFactory.createUtilityCommand(
    'debug-permissions',
    'üê∑ Check bot permissions (Debug)',
    [],
    { isEphemeral: true }
));

// In handler
const permissions = interaction.guild?.members.me?.permissions;
const permissionList = permissions?.toArray().join(', ') || 'None';
await interaction.reply({ content: `**Bot Permissions:**\n${permissionList}`, ephemeral: true });
```

### Check Service Status
```typescript
// Add debug command
this.registerCommand(CommandFactory.createUtilityCommand(
    'debug-services',
    'üê∑ Check service status (Debug)',
    [],
    { isEphemeral: true }
));

// In handler
const services = {
    payment: !!this.serviceContainer.paymentHandler,
    userAccount: !!this.serviceContainer.userAccountService,
    serverConfig: !!this.serviceContainer.serverConfigService
};
await interaction.reply({ content: `**Service Status:**\n${JSON.stringify(services, null, 2)}`, ephemeral: true });
```

## üö® Common Errors & Fixes

### Command Not Appearing
- ‚úÖ Check command is registered in `CommandRegistry`
- ‚úÖ Check command is routed in `InteractionRouter`
- ‚úÖ Check bot has proper permissions
- ‚úÖ Restart bot to re-register commands

### Permission Denied
- ‚úÖ Check bot permissions in Discord server
- ‚úÖ Check user permissions in command handler
- ‚úÖ Verify `guildOnly` and permission flags

### Service Not Found
- ‚úÖ Check service is added to `ServiceContainer`
- ‚úÖ Check service constructor parameters
- ‚úÖ Verify service lifecycle management

### Database Errors
- ‚úÖ Check database connection string
- ‚úÖ Run `npx prisma generate` after schema changes
- ‚úÖ Run `npx prisma migrate dev` for new migrations

## üìö Useful Commands

### Development
```bash
# Generate Prisma client
npx prisma generate

# Run migrations
npx prisma migrate dev

# Reset database
npx prisma migrate reset

# Open database
npx prisma studio

# Run tests
npm test

# Run tests with coverage
npm run test:coverage

# Run specific test file
npm test -- MyCommandHandler.test.ts
```

### Bot Management
```typescript
// Toggle enhanced commands
bot.toggleEnhancedCommands(false);

// Get command statistics
const stats = await bot.getCommandStats();

// Reload commands
await bot.reloadCommands();

// Stop bot
await bot.stop();
```

---

*Keep this reference handy for quick development tasks!* üê∑‚ú®
